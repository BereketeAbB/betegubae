<!DOCTYPE html>
<html lang="am">
<head>
  <meta charset="UTF-8">
  <title>Lyrics Player with Multiple Verses</title>
  <style>
    body {
      font-family: "Noto Sans Ethiopic", sans-serif;
      line-height: 1.4;
      font-size: 26px;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background-color: #f8f9fa;
    }

    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    /* Lyrics section styling */
    #lyrics-container {
      margin: 30px 0;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }

    .verse-section {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .verse-header {
      font-size: 20px;
      margin-bottom: 15px;
      color: #3498db;
      font-weight: bold;
    }

    .lyrics-paragraph {
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .word-container {
      display: inline;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      padding: 2px;
      border-radius: 3px;
    }

    .word-container:hover {
      background-color: #f0f0f0;
    }

    .char-with-symbols {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      vertical-align: bottom;
    }

    .melody-line {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 1px;
      min-height: 12px;
      font-family: 'Zemayared2', 'Noto Sans Ethiopic', sans-serif;
    }

    .base-char {
      font-size: 26px;
      min-height: 25px;
      display: flex;
      align-items: flex-end;
      font-family: 'Noto Sans Ethiopic', sans-serif;
    }

    .black-symbol {
      color: black;
      font-size: 0.5em;
      font-weight: bold;
      margin: 0;
      line-height: 0.8;
    }

    .red-symbol {
      color: red;
      font-size: 0.5em;
      font-weight: bold;
      margin: 0;
      line-height: 0.8;
    }

    .empty-symbol {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 1px;
    }

    .clickable-symbol {
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
    }

    .clickable-symbol:hover {
      color: blue;
      transform: scale(1.1);
    }

    .locked {
      background-color: #ffdede;
    }

    .line-break {
      display: block;
      height: 15px;
    }

    .empty-line {
      display: block;
      height: 25px;
      border-bottom: 1px dashed #ddd;
    }

    /* Load Zemayared2 font */
    @font-face {
      font-family: 'Zemayared2';
      src: url('./Zemayared2.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
  </style>
</head>

<body>

  <h2>ምስባክ ዘጥቅምት 25</h2>

  <audio id="audio" controls>
    <source src="./symbols/compressed/01-WedaseMar_Monday.mp3" type="audio/mp3">
    Your browser does not support the audio element.
  </audio>

  <div id="lyrics-container">
    <!-- Lyrics will be rendered here by JavaScript -->
  </div>

  <script>
    // Page data structure
    const pageData = [
      {
        title: "ምስባክ ዘጥቅምት 25",
        audioSrc: "./symbols/compressed/01-WedaseMar_Monday.m4a",
        lyricsTimestamp: [
          {
            key: "ዘሠኑይ",
            data: [
              { time: 1.14, end: 1.18, text: "ክቡ[ቡበ][,]‹ሠረ›ር" },
              { time: 1.19, end: 1.23, text: "ሞቱ[በእ][ጠጠ]‹ቀለ›" },
              { time: 1.24, end: 1.28, text: "ለ[,][~]ጻድ[.][,]ቅ[ፈ][ቀ]‹ነኪ›" },
              { time: 1.29, end: 1.34, text: "በቅ[~]ድመ[,] እ[V]ግዚ[.][.]ብሔር።" },
              { time: 1.35, end: 1.40, text: "።" }, // Empty line example
              { time: 1.41, end: 1.46, text: "እ[~]ግ[][V]ዚኦ[ፔር][ዴ]" },
              { time: 1.47, end: 1.52, text: "አ[,][.]ነ[ነኒ][፴][ፈጠ][ድን]" },
              { time: 1.53, end: 1.58, text: "ገብር[:]ከ[ጠጠ,]።" },
              { time: 1.59, end: 1.64, text: "።" }, // Another empty line
              { time: 1.65, end: 1.70, text: "ገ[~][~][~]ብር[^][V]ከ[ሳን][ፈጠ][ድን]" },
              { time: 1.71, end: 1.76, text: "ወ[-]ልደ[V] አመ[,]ት[:]ከ[ስ]።" },
            ]
          },
        ],
        translationData: [
          {
            key: "ፈቀደ እግዚእ",
            data: [
              {
                reading: {
                  am: "-",
                  en: "-",
                  gz: "-"
                },
                commentaries: []
              }
            ]
          }
        ]
      },
      {
        title: "ምስባክ ዘጥቅምት 21",
        audioSrc: "./symbols/compressed/01-WedaseMar_Monday.m4a",
        lyricsTimestamp: [
          {
            key: "ዘሠኑይ",
            data: [
              { time: 1.14, end: 1.18, text: "ክቡ[ቡበ][,]‹ሠረ›ር" },
              { time: 1.19, end: 1.23, text: "ሞቱ[በእ][ጠጠ]‹ቀለ›" },
              { time: 1.24, end: 1.28, text: "ለ[,][~]ጻድ[.][,]ቅ[ፈ][ቀ]‹ነኪ›" },
              { time: 1.29, end: 1.34, text: "በቅ[~]ድመ[,] እ[V]ግዚ[.][.]ብሔር።" },
              { time: 1.35, end: 1.40, text: "።" }, // Empty line example
              { time: 1.41, end: 1.46, text: "እ[~]ግ[][V]ዚኦ[ፔር][ዴ]" },
              { time: 1.47, end: 1.52, text: "አ[,][.]ነ[ነኒ][፴][ፈጠ][ድን]" },
              { time: 1.53, end: 1.58, text: "ገብር[:]ከ[ጠጠ,]።" },
              { time: 1.59, end: 1.64, text: "።" }, // Another empty line
              { time: 1.65, end: 1.70, text: "ገ[~][~][~]ብር[^][V]ከ[ሳን][ፈጠ][ድን]" },
              { time: 1.71, end: 1.76, text: "ወ[-]ልደ[V] አመ[,]ት[:]ከ[ስ]።" },
            ]
          },
        ],
        translationData: [
          {
            key: "ፈቀደ እግዚእ",
            data: [
              {
                reading: {
                  am: "-",
                  en: "-",
                  gz: "-"
                },
                commentaries: []
              }
            ]
          }
        ]
      },
    ];

   const symbolSounds = {
      "ለኪ": "./symbols/compressed/1.selamleki.m4a",
      "ነኪ": "./symbols/compressed/6.yekednekitsyone.m4a",
      "፴": "./symbols/compressed/11.selasa.m4a",
      "ምን": "./symbols/compressed/14.mente.m4a",
      "ቀ": "./symbols/compressed/15.atmeke.m4a",
      "ልብ": "./symbols/compressed/16.hezunewetkuzelebe.m4a",
      "ሠም": "./symbols/compressed/18.semre.m4a",
      "ሰአ": "./symbols/compressed/22.sealilene.m4a",
      "ኃኒ": "./symbols/compressed/23.medhanit.m4a",
      "ትስ": "./symbols/compressed/24.tsali.m4a",
      "ዴ": "./symbols/compressed/29.weyastedelu.m4a",
      "ሴፍ": "./symbols/compressed/30.yosefe.m4a",
      "ሮን": "./symbols/compressed/34.beterearone.m4a",
      "አቡ": "./symbols/compressed/41.abuhu.m4a",
      "ጠጠ": "./symbols/compressed/42.wesetete.m4a",
      "ጎል": "./symbols/compressed/61.gole.m4a",
    };

    // DOM elements
    const lyricsContainer = document.getElementById("lyrics-container");
    const audio = document.getElementById("audio");

    // Function to parse text into character-symbol pairs
    function parseTextWithSymbols(text) {
      const result = [];
      let currentChar = '';
      let symbols = [];

      let i = 0;
      while (i < text.length) {
        const char = text[i];

        if (char === '[') {
          // Found black symbol
          const symbolEnd = text.indexOf(']', i);
          if (symbolEnd !== -1) {
            const symbolContent = text.substring(i + 1, symbolEnd);
            symbols.push({
              content: symbolContent,
              type: 'black'
            });
            i = symbolEnd + 1;
            continue;
          }
        } else if (char === '‹') {
          // Found red symbol
          const symbolEnd = text.indexOf('›', i);
          if (symbolEnd !== -1) {
            const symbolContent = text.substring(i + 1, symbolEnd);
            symbols.push({
              content: symbolContent,
              type: 'red'
            });
            i = symbolEnd + 1;
            continue;
          }
        } else if (char === '<') {
          // Found red symbol (alternative)
          const symbolEnd = text.indexOf('>', i);
          if (symbolEnd !== -1) {
            const symbolContent = text.substring(i + 1, symbolEnd);
            symbols.push({
              content: symbolContent,
              type: 'red'
            });
            i = symbolEnd + 1;
            continue;
          }
        } else {
          // Regular character
          if (currentChar) {
            result.push({
              char: currentChar,
              symbols: [...symbols]
            });
            symbols = [];
          }
          currentChar = char;
        }
        i++;
      }

      // Add last character
      if (currentChar || symbols.length > 0) {
        result.push({
          char: currentChar,
          symbols: [...symbols]
        });
      }

      return result;
    }

    // Function to render a single word with symbols
    function renderWord(text) {
      const container = document.createElement("span");
      container.classList.add("word-container");

      const parsed = parseTextWithSymbols(text);

      parsed.forEach((item, index) => {
        const charWithSymbols = document.createElement("span");
        charWithSymbols.classList.add("char-with-symbols");

        // Create ONE symbol per melody line (stacked vertically)
        // Reverse the symbols so last symbol appears closest to text
        const reversedSymbols = [...item.symbols].reverse();

        reversedSymbols.forEach((symbol, symbolIndex) => {
          const melodyLineDiv = document.createElement("div");
          melodyLineDiv.classList.add("melody-line");

          const symbolSpan = document.createElement("span");
          if (symbol.content === "") {
            // Empty symbol
            symbolSpan.classList.add("empty-symbol");
            symbolSpan.innerHTML = "•";
            symbolSpan.style.color = "lightgray";
            symbolSpan.title = "Empty symbol";
          } else {
            // Non-empty symbol
            symbolSpan.classList.add(`${symbol.type}-symbol`, "clickable-symbol");
            symbolSpan.textContent = symbol.content;
            symbolSpan.setAttribute('data-symbol', symbol.content);
          }
          melodyLineDiv.appendChild(symbolSpan);
          charWithSymbols.appendChild(melodyLineDiv);
        });

        // Add base character
        const baseChar = document.createElement("span");
        baseChar.classList.add("base-char");
        baseChar.textContent = item.char;
        charWithSymbols.appendChild(baseChar);

        container.appendChild(charWithSymbols);
      });

      // Add click events to symbols
      container.querySelectorAll(".clickable-symbol").forEach(s => {
        s.addEventListener("click", (e) => {
          e.stopPropagation();
          const symbolText = s.getAttribute('data-symbol');
          console.log(`Clicked symbol: "${symbolText}"`);
          playSymbolSound(symbolText);
        });
      });

      return container;
    }

    // Function to play symbol sound
    function playSymbolSound(symbolText) {
      let soundFile = symbolSounds[symbolText];
      if (soundFile) {
        const audioElement = new Audio(soundFile);
        audioElement.play().catch(error => {
          console.error("Error playing symbol sound:", error);
        });
      } else {
        console.warn(`No sound found for symbol: ${symbolText}`);
      }
    }

    // NEW: Function to group segments into lines based on ።
    function groupSegmentsIntoLines(segments) {
      const lines = [];
      let currentLine = [];

      segments.forEach(segment => {
        // Add segment to current line
        currentLine.push(segment);

        // Check if this segment ends with ። (not empty line)
        if (segment.text.trim() !== "።" && segment.text.includes('።')) {
          // This segment contains ። - end the line
          lines.push([...currentLine]);
          currentLine = [];
        } else if (segment.text.trim() === "።") {
          // This is an empty line - add it as a separate line
          lines.push([segment]);
          currentLine = [];
        }
        // Otherwise, continue adding to current line
      });

      // Add any remaining segments as the last line
      if (currentLine.length > 0) {
        lines.push(currentLine);
      }

      return lines;
    }

    // Render lyrics
    function renderLyrics(lyricsTimestamp) {
      lyricsContainer.innerHTML = '';

      lyricsTimestamp.forEach((group, groupIndex) => {
        const verseSection = document.createElement("div");
        verseSection.className = "verse-section";

        const verseHeader = document.createElement("div");
        verseHeader.className = "verse-header";
        verseHeader.textContent = group.key;
        verseSection.appendChild(verseHeader);

        // Group segments into lines based on ።
        const lines = groupSegmentsIntoLines(group.data);

        // Render each line
        lines.forEach((lineSegments, lineIndex) => {
          const lineContainer = document.createElement("div");
          lineContainer.className = "lyrics-paragraph";

          lineSegments.forEach((segment, segmentIndex) => {
            // Check if this is an empty line
            if (segment.text.trim() === "።") {
              const emptyLine = document.createElement("div");
              emptyLine.classList.add("empty-line");
              emptyLine.title = "Empty line";
              emptyLine.dataset.time = segment.time;
              emptyLine.dataset.end = segment.end;
              emptyLine.style.cursor = 'pointer';
              emptyLine.onclick = () => {
                audio.currentTime = segment.time;
                audio.play();
              };
              lineContainer.appendChild(emptyLine);
            } else {
              // Regular text - render normally
              const segmentContainer = document.createElement("span");
              segmentContainer.style.display = 'inline';

              const words = segment.text.split(/( )/);

              words.forEach((word, wordIndex) => {
                if (word === ' ') {
                  // Add space
                  segmentContainer.appendChild(document.createTextNode(' '));
                } else if (word.trim()) {
                  // Render word with symbols
                  const wordElement = renderWord(word);
                  segmentContainer.appendChild(wordElement);
                }
              });

              // Add click event for audio playback
              segmentContainer.dataset.time = segment.time;
              segmentContainer.dataset.end = segment.end;
              segmentContainer.style.cursor = 'pointer';
              segmentContainer.onclick = () => {
                audio.currentTime = segment.time;
                audio.play();
              };

              lineContainer.appendChild(segmentContainer);
            }
          });

          verseSection.appendChild(lineContainer);
        });

        lyricsContainer.appendChild(verseSection);

      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Log all pageData
      console.log('Loading all pageData:', pageData);
      pageData.forEach((p, i) => console.log(`pageData[${i}]`, p));

      // Combine all groups from every page and prefix keys with page title so we can render all at once
      const combinedGroups = [];
      pageData.forEach(page => {
        page.lyricsTimestamp.forEach(group => {
          combinedGroups.push({
            ...group,
            key: `${page.title} · ${group.key}`
          });
        });
      });

      // Render combined groups (renders all pages' groups)
      renderLyrics(combinedGroups);
    });
  </script>

</body>
</html>