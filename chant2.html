<!DOCTYPE html>
<html lang="am">
<head>
  <meta charset="UTF-8">
  <title>Lyrics Player with Multiple Verses</title>
  <style>
    body {
      font-family: "Noto Sans Ethiopic", sans-serif;
      line-height: 1.4;
      font-size: 26px;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background-color: #f8f9fa;
    }

    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    /* Lyrics section styling */
    #lyrics-container {
      margin: 30px 0;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }

    .verse-section {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .verse-header {
      font-size: 20px;
      margin-bottom: 15px;
      color: #3498db;
      font-weight: bold;
    }

    .lyrics-paragraph {
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .word-container {
      display: inline;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      padding: 2px;
      border-radius: 3px;
    }

    .word-container:hover {
      background-color: #f0f0f0;
    }

    .char-with-symbols {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      vertical-align: bottom;
    }

    .melody-line {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 1px;
      min-height: 12px;
      font-family: 'ZemaYared', 'Noto Sans Ethiopic', sans-serif;
    }

    .base-char {
      font-size: 26px;
      min-height: 25px;
      display: flex;
      align-items: flex-end;
      font-family: 'Noto Sans Ethiopic', sans-serif;
    }

    .black-symbol {
      color: black;
      font-size: 0.5em;
      font-weight: bold;
      margin: 0;
      line-height: 0.8;
    }

    .red-symbol {
      color: red;
      font-size: 0.5em;
      font-weight: bold;
      margin: 0;
      line-height: 0.8;
    }

    .empty-symbol {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 1px;
    }

    .clickable-symbol {
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
    }

    .clickable-symbol:hover {
      color: blue;
      transform: scale(1.1);
    }

    .locked {
      background-color: #ffdede;
    }

    /* Load ZemaYared font */
    @font-face {
      font-family: 'ZemaYared';
      src: url('./ZemaYared.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
  </style>
</head>

<body>

  <h2>ውዳሴ ማርያም ዘሰኑይ</h2>

  <audio id="audio" controls>
    <source src="./symbols/compressed/01-WedaseMar_Monday.mp3" type="audio/mp3">
    Your browser does not support the audio element.
  </audio>

  <div id="lyrics-container">
    <!-- Lyrics will be rendered here by JavaScript -->
  </div>

  <script>
    // Page data structure
    const pageData = [
      {
        title: "ምስባክ ዘጥቅምት 25",
        audioSrc: "./symbols/compressed/01-WedaseMar_Monday.m4a",
        lyricsTimestamp: [
          {
            key: "ዘሠኑይ",
            data: [
              { time: 1.14, end: 1.18, text: "ክቡ[ቡበ][,]‹ሠረ›ር ሞቱ[በእ][ጠጠ]‹ቀለ›" },
              { time: 1.18, end: 1.28, text: "ለ[,][~]ጻድ[.][,]ቅ[ፈ][ቀ]‹ነኪ›" },
              { time: 1.29, end: 1.34, text: "በቅ[~]ድመ[,] እ[V]ግዚ[.][.]ብሔር።" },
              { time: 1.29, end: 1.34, text: "እ[~]ግ[][V]ዚኦ[ፔር][ዴ] አ[,][.]ነ[ነኒ][፴][ፈጠ][ድን] ገብር[፡]ከ[ጠጠ,]።" },
              { time: 1.29, end: 1.34, text: "ገ[~][~][~]ብር[^][V]ከ[ሳን][ፈጠ][ድን] ወ[-]ልደ[V] አመ[,]ት[:]ከ[ስ]።" },
            ]
          },
        ],
        translationData: [
          {
            key: "ፈቀደ እግዚእ",
            data: [
              {
                reading: {
                  am: "-",
                  en: "-",
                  gz: "-"
                },
                commentaries: []
              }
            ]
          }
        ]
      }
    ];

    const symbolSounds = {
      "ለኪ": "./symbols/compressed/1.selamleki.m4a",
      "ነኪ": "./symbols/compressed/6.yekednekitsyone.m4a",
      "፴": "./symbols/compressed/11.selasa.m4a",
      "ምን": "./symbols/compressed/14.mente.m4a",
      "ቀ": "./symbols/compressed/15.atmeke.m4a",
      "ልብ": "./symbols/compressed/16.hezunewetkuzelebe.m4a",
      "ሠም": "./symbols/compressed/18.semre.m4a",
      "ሰአ": "./symbols/compressed/22.sealilene.m4a",
      "ኃኒ": "./symbols/compressed/23.medhanit.m4a",
      "ትስ": "./symbols/compressed/24.tsali.m4a",
    };

    // DOM elements
    const lyricsContainer = document.getElementById("lyrics-container");
    const audio = document.getElementById("audio");

    // NEW: Simple parser that creates one symbol per melody line
    function parseTextWithSymbols(text) {
      const result = [];
      let currentChar = '';
      let symbols = [];

      let i = 0;
      while (i < text.length) {
        const char = text[i];

        if (char === '[') {
          // Found black symbol
          const symbolEnd = text.indexOf(']', i);
          if (symbolEnd !== -1) {
            const symbolContent = text.substring(i + 1, symbolEnd);
            symbols.push({
              content: symbolContent,
              type: 'black'
            });
            i = symbolEnd + 1;
            continue;
          }
        } else if (char === '‹') {
          // Found red symbol
          const symbolEnd = text.indexOf('›', i);
          if (symbolEnd !== -1) {
            const symbolContent = text.substring(i + 1, symbolEnd);
            symbols.push({
              content: symbolContent,
              type: 'red'
            });
            i = symbolEnd + 1;
            continue;
          }
        } else if (char === '<') {
          // Found red symbol (alternative)
          const symbolEnd = text.indexOf('>', i);
          if (symbolEnd !== -1) {
            const symbolContent = text.substring(i + 1, symbolEnd);
            symbols.push({
              content: symbolContent,
              type: 'red'
            });
            i = symbolEnd + 1;
            continue;
          }
        } else {
          // Regular character
          if (currentChar) {
            result.push({
              char: currentChar,
              symbols: [...symbols]
            });
            symbols = [];
          }
          currentChar = char;
        }
        i++;
      }

      // Add last character
      if (currentChar || symbols.length > 0) {
        result.push({
          char: currentChar,
          symbols: [...symbols]
        });
      }

      return result;
    }

    // Function to render a single word with symbols
    function renderWord(text) {
      const container = document.createElement("span");
      container.classList.add("word-container");

      const parsed = parseTextWithSymbols(text);

      parsed.forEach((item, index) => {
        const charWithSymbols = document.createElement("span");
        charWithSymbols.classList.add("char-with-symbols");

        // Create ONE symbol per melody line (stacked vertically)
        // Reverse the symbols so last symbol appears closest to text
        const reversedSymbols = [...item.symbols].reverse();

        reversedSymbols.forEach((symbol, symbolIndex) => {
          const melodyLineDiv = document.createElement("div");
          melodyLineDiv.classList.add("melody-line");

          const symbolSpan = document.createElement("span");
          if (symbol.content === "") {
            // Empty symbol
            symbolSpan.classList.add("empty-symbol");
            symbolSpan.innerHTML = "•";
            symbolSpan.style.color = "lightgray";
            symbolSpan.title = "Empty symbol";
          } else {
            // Non-empty symbol
            symbolSpan.classList.add(`${symbol.type}-symbol`, "clickable-symbol");
            symbolSpan.textContent = symbol.content;
            symbolSpan.setAttribute('data-symbol', symbol.content);
          }
          melodyLineDiv.appendChild(symbolSpan);
          charWithSymbols.appendChild(melodyLineDiv);
        });

        // Add base character
        const baseChar = document.createElement("span");
        baseChar.classList.add("base-char");
        baseChar.textContent = item.char;
        charWithSymbols.appendChild(baseChar);

        container.appendChild(charWithSymbols);
      });

      // Add click events to symbols
      container.querySelectorAll(".clickable-symbol").forEach(s => {
        s.addEventListener("click", (e) => {
          e.stopPropagation();
          const symbolText = s.getAttribute('data-symbol');
          console.log(`Clicked symbol: "${symbolText}"`);
          playSymbolSound(symbolText);
        });
      });

      return container;
    }

    // Function to play symbol sound
    function playSymbolSound(symbolText) {
      let soundFile = symbolSounds[symbolText];
      if (soundFile) {
        const audioElement = new Audio(soundFile);
        audioElement.play().catch(error => {
          console.error("Error playing symbol sound:", error);
        });
      } else {
        console.warn(`No sound found for symbol: ${symbolText}`);
      }
    }

    // Render lyrics
    function renderLyrics(lyricsTimestamp) {
      lyricsContainer.innerHTML = '';

      lyricsTimestamp.forEach((group, groupIndex) => {
        const verseSection = document.createElement("div");
        verseSection.className = "verse-section";

        const verseHeader = document.createElement("div");
        verseHeader.className = "verse-header";
        verseHeader.textContent = group.key;
        verseSection.appendChild(verseHeader);

        // Create a paragraph container for all segments
        const paragraphContainer = document.createElement("div");
        paragraphContainer.className = "lyrics-paragraph";

        group.data.forEach((segment, segmentIndex) => {
          const wordElement = renderWord(segment.text);
          wordElement.dataset.time = segment.time;
          wordElement.dataset.end = segment.end;

          wordElement.onclick = () => {
            audio.currentTime = segment.time;
            audio.play();
          };

          paragraphContainer.appendChild(wordElement);

          // Add space between words
          if (segmentIndex < group.data.length - 1) {
            paragraphContainer.appendChild(document.createTextNode(' '));
          }
        });

        verseSection.appendChild(paragraphContainer);
        lyricsContainer.appendChild(verseSection);
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      renderLyrics(pageData[0].lyricsTimestamp);
    });
  </script>

</body>
</html>